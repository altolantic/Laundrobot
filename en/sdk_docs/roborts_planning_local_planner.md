# Local Path Planner

## Module Introduction

Local Path Planner Module calculates the optimal speed without collision for the robot, based on the Odometry information, LiDAR sensoring information, and the optimal path output from the Global Path Planner.

Local Path Planner Module is located in `roborts_planner` package, it depends on the action and msgs in `roborts_msgs` package, and the abstract factory mode and parameter reader in `roborts_common`. 


The Local Path Planner has the following hierachy:

```bash
local_planner
├── CMakeLists.txt
├── config
│   └── local_planner.prototxt          # Local Path Planner configuration file
├── include
│   └── local_planner
│       ├── proto 
│       │   ├── local_planner.pb.cc
│       │   ├── local_planner.pb.h
│       │   └── local_planner.proto     # Local Path Planner parameter generation file
│       ├── data_base.h                 # Local Path Planner data structures, used to build g2o edges and vertices
│       ├── data_converter.h            # Data converter, used to convert data into data_base structure
│       ├── distance_calculation.h      # Calculates distances between 2D points, lines, and geometry shapes
│       ├── line_iterator.h             # Calculates coordinates for continues line segments in discrete grid
│       ├── local_planner_algorithms.h  # Local Path Planner header files (all algorithm header files should be included in this file)
│       ├── local_planner_base.h        # Superclass for Local Path Planner algorithm
│       ├── local_planner_node.h        # Local Path Planner entry node
│       ├── local_visualization.h       # Visualization of Local Path Planner result
│       ├── obstacle.h                  # 2D obstacle information
│       ├── odom_info.h                 # Odometry information
│       ├── optimal_base.h              # Superclass for optimization algorithms
│       ├── robot_footprint_model.h     # Robot dimension descriptions
│       ├── robot_position_cost.h       # Cost calculation for robot position, used for determine the avalibility of the path
│       └── utility_tool.h              # Utility tool functions
├── src
│   ├── local_planner_node.cpp          # ros node file，used for logical scheduling inside the Local Path Planner
│   ├── vel_converter.cpp               # ros node file, convert the velocity into "cmd_vel" and publish it during the simulation
│   ├── teb_test.cpp                    # timed elastic band test file
│   └── ...
└── timed_elastic_band
    ├── CMakeLists.txt
    ├── config
    │   └── timed_elastic_band.prototxt # timed elastic band configuration file
    ├── include
    │   └── timed_elastic_band
    │       ├── proto
    │       │   ├── timed_elastic_band.pb.cc
    │       │   ├── timed_elastic_band.pb.h
    │       │   └── timed_elastic_band.proto
    │       ├── teb_local_planner.h     # timed elastic band implementation，inherited from local_planner_base.h
    │       ├── teb_optimal.h           # g2o optimization logic，inherited from optimal_base.h
    │       └── ...                     # other g2o edge and vertex files
    └── src
        ├── teb_local_planner.cpp       # timed elastic band implementation
        ├── teb_optimal.cpp             # g2o optimization logic
        └── ...

```

Local Path Planner related algorithms please refer to [Time Elastic Band](en/sdk_docs/roborts_planning_local_planner?id=timed-elastic-band)


local_planner_node is the core planning node，the ROS node graph is shown below:

![](https://rm-static.djicdn.com/documents/20758/708f059fc647c1547553602751260545.png)

The output of the node as follows:

### Input

- /tf ([tf/tfMessage](http://docs.ros.org/api/tf/html/msg/tfMessage.html))

  (Required) Use `TransformListener` to monitor the conversion of map->odom，provided by roborts_localization package in roborts framework

- local_costmap object(`roborts_costmap/CostmapInterface`)

  (Required) Can be used to represents the local grid cost map in obstacle layer(local_costmap), depends on topic /tf, /scan(obstacle layer)，provided by roborts_costmap package in roborts framework.

- /local_planner_node_action/goal (roborts_msgs/LocalPlannerGoal)

  (Required) From `Actionlib Client` to `Actionlib Server` input the path generated by Global Path Planner, the interface is encapsulted using Actionlib，the topic type is ([nav_msgs/Path](http://docs.ros.org/melodic/api/nav_msgs/html/msg/Path.html))

- /locall_planner_node_action/cancel ([actionlib_msgs/GoalID](http://docs.ros.org/melodic/api/actionlib_msgs/html/msg/GoalID.html))

  From `Actionlib Client` to `Actionlib Server` to apply calceling the Local Planning task, the interface is encapsulted using Actionlib.

### Output

- /local_planner_node_action/feedback (roborts_msgs/LocalPlannerFeedback)

  `Actionlib Server` generates real-time feedback of the error code and error message for Local Path Planner, the interface is encapsulted using Actionlib.

- /local_planner_node_action/result (roborts_msgs/LocalPlannerResult)

  Not used

- /local_planner_node_action/status ([actionlib_msgs/GoalStatusArray](http://docs.ros.org/melodic/api/actionlib_msgs/html/msg/GoalStatusArray.html))  

  `Actionlib Server` generates the real-time feedback of the planning status, the interface is encapsulted using Actionlib.

- /local_planner_node/trajectory([nav_msgs/Path](http://docs.ros.org/melodic/api/nav_msgs/html/msg/Path.html))  

  Used for visualizing the path of Local Planner.

- /local_costmap/local_costmap/costmap ([nav_msgs/OccupancyGrid](http://docs.ros.org/melodic/api/nav_msgs/html/msg/OccupancyGrid.html))  

  Used for visualizing the Local Grid Costmap.



## Compile and Run

### Compile

Before compiling, make sure installed all the dependencies. In your ROS workspace run the following command

```shell
catkin_make local_planner_node vel_converter teb_test
```

### Run

```shell
# Launch the Local Planner node
rosrun roborts_planning local_planner_node
# Launch vel_converter
rosrun roborts_planning vel_converter
# Launch timed elastic band test node
rosrun roborts_planning teb_test
```

Or using launch file

```xml
<!-- Run the local planner Node -->
<node pkg="roborts_planning" type="local_planner_node" name="local_planner_node" respawn="false" />
<!-- Run the vel converter Node -->
<node pkg="roborts_planning" type="vel_converter" name="vel_converter_node" respawn="false" />
```

## Timed Elastic Band
### Algorithm Introduction

The algorithm built-in the objective function for the path execution time, optimizes the actual moving path and calculates the optimal velocity, while keeping the safe distance with obstacles, and comply with the robot Kinematics. More theoretical detail can be found in paper:

* C. Rösmann, F. Hoffmann and T. Bertram: Integrated online trajectory planning and optimization in distinctive topologies, Robotics and Autonomous Systems, Vol. 88, 2017, pp. 142–153.

### Related Parameters

#### Path Parameters

* teb_autosize 

	Whether or not re-calculating the path

* dt_ref 

	Initial time constant

* dt_hysteresis 

	Time compensate constant

* global_plan_overwrite_orientation 

	Whether or not re-write the orientation for Path Planning position

* allow_init_with_backwards_motion 

	Whether or not allowing backward motion

* global_plan_viapoint_sep 

	Choose required Global Path Planning point

* via_points_ordered 

	Go to the waypoints via points order

* max_global_plan_lookahead_dist

	Look ahead distance for Local Path Planning

* exact_arc_length 

	Arc length between two positions

* force_reinit_new_goal_dist 

	Force reinitialize new goal for Local Path Planner

* feasibility_check_no_poses

	Calculate number of feasibility points for path

* publish_feedback 

	Not used

* min_samples 

	Minimum samples for path

* max_samples 

	Maximum samples for path


#### Kinematics Parameters


* max_vel_x 

	Maximum forward velocity

* max_vel_x_backwards 

	Maximum backward velocity

* max_vel_y 

	Maximum translation velocity

* max_vel_theta

	Maximum angular velocity

* acc_lim_x

	Maximum forward/backward acceleration

* acc_lim_y 

	Maximum translation acceleration

* acc_lim_theta 

	Maximum angular acceleration

* min_turning_radius

	Minimum turning radius

* wheelbase

    Not used

* cmd_angle_instead_rotvel

    Not used

#### Tolerance Parameters

*   xy_goal_tolerance

	Goal distance tolerance

*   yaw_goal_tolerance

	Goal angular tolerance

*   free_goal_vel

	Free goal velocity


#### Obstacle Parameters

* min_obstacle_dist

	Minimum obstacle distance
    
* inflation_dist

	Obstacle inflation distance

* include_costmap_obstacles

	Not used, whether include costmap obstacles

* costmap_obstacles_behind_robot_dist

	Threshold for obstacle costmap behind the robot

* obstacle_poses_affected

    Obstacles that affect the number of waypoints, only works when legacy_obstacle_association is true

* legacy_obstacle_association

    Select optimization objective to be the closest waypoint to the obstacle, or the closest obstacle to the waypoint

* obstacle_association_cutoff_factor

	Do not consider the factor of obstacle, only works when legacy_obstacle_association is false

* obstacle_association_force_inclusion_factor

	Force consider the factor of obstacle, only works when legacy_obstacle_association is false

#### Optimization Parameters

* no_inner_iterations 

	The number of iterations for the solver when the path adjustment is done

* no_outer_iterations 

	The number of automatic path adjustment

* optimization_activate

	Whether or not start optimization

* optimization_verbose

	Whether or not output debug message for optimization

* penalty_epsilon

	Constrained cost function conpensition

* weight_max_vel_x

	Maximum x velocity weight

* weight_max_vel_y

	Maximum y velocity weight

* weight_max_vel_theta

	Maximum angular velocity weight

* weight_acc_lim_x

	Maximum x acceleration weight

* weight_acc_lim_y

	Maximum y acceleration weight

* weight_acc_lim_theta

	Maximum angular acceleration weight

* weight_kinematics_nh

	Non complete Kinematics constraint weight

* weight_kinematics_forward_drive

	Forward drive weight

* weight_kinematics_turning_radius

	Minimum steering radius weight, car like model

* weight_optimaltime

	Optimization track time weight

* weight_obstacle

	Minimum distance to obstacle weight

* weight_inflation

	Weight after inflation

* weight_dynamic_obstacle

	Dynamic obstacle weight

* weight_viapoint

	Minimum distance to waypoint weight

* weight_adapt_factor

	Weight adaptation factor, only used in obstacle for now

* weight_prefer_rotdir

	Steering weight